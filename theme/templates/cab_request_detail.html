{% extends 'base.html' %}
{% load heroicons%}

{% block title %}CAB Request Detail{% endblock %}

{% block sidebar %}
<div class="sidebar">
    <nav class="dashboard-menu">
        <ul>
            <li><a href="{% url 'cab' %}">CAB Dashboard {% heroicon_outline "folder-plus" %}</a></li>
            <li><a href="{% url 'cab_stats' %}">CAB Stats {% heroicon_outline "chart-bar" %}</a></li>
            <li><a href="{% url 'logout' %}">Logout {% heroicon_outline "arrow-left-on-rectangle" %}</a></li>
        </ul>
    </nav>
</div>
{% endblock %}

{% block content %}
<style>

    .w-40 { width: 20%; }
    .text-preformatted { white-space: pre-wrap; }
    .table-striped tbody tr:nth-of-type(odd) { background-color: #f9f9f9; }
    .card-header { border-radius: 0.375rem 0.375rem 0 0 !important; }
    .form-select { transition: all 0.2s ease; }
    .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }


    

</style>




<div class="container py-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
        </div>
        
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-4">
                    <tbody>
                        <tr>
                            <th scope="row" class="w-40">Change Type</th>
                            <td>{{ request_obj.change_type }}</td>
                        </tr>
                        <tr>
                            <th>Description</th>
                            <td class="text-preformatted">{{ request_obj.description }}</td>
                        </tr>
                        <tr>
                            <th>Risk Assessment</th>
                            <td>{{ request_obj.risk_assessment }}</td>
                        </tr>
                        <tr>
                            <th>Implementation Plan</th>
                            <td>{{ request_obj.implementation_plan }}</td>
                        </tr>
                        <tr>
                            <th>Rollback Plan</th>
                            <td>{{ request_obj.rollback_plan }}</td>
                        </tr>
                        <tr>
                            <th>Status</th>
                            <td><span class="badge bg-secondary">{{ request_obj.status }}</span></td>
                        </tr>
                        <tr>
                            <th>Requested By</th>
                            <td>{{ request_obj.requester.full_name|default:request_obj.requester.username|default:"N/A" }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <form method="post" class="border-top pt-4">
                {% csrf_token %}
                <input type="hidden" name="action" id="formAction" value="">
                
                <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                    <button type="button" id="approveButton" class="btn btn-success btn-lg">
                        <i class="bi bi-check-circle me-2"></i>Approve
                    </button>
                    <button type="button" id="rejectButton" class="btn btn-danger btn-lg">
                        <i class="bi bi-x-circle me-2"></i>Reject
                    </button>
                </div>

                <div id="rejectionReasonDiv" class="mt-4 collapse">
                    <div class="card card-body bg-light">
                        <h5 class="mb-3">Rejection Details</h5>
                        <div class="mb-3">
                            <label for="rejection_reason" class="form-label">Select Reason:</label>
                            <select name="rejection_reason" class="form-select" required>
                                <option value="insufficient_info">Insufficient Information</option>
                                <option value="high_risk">High Risk</option>
                                <option value="no_business_justification">No Business Justification</option>
                                <option value="incomplete_rollback_plan">Incomplete Rollback Plan</option>
                                <option value="resource_constraints">Resource Constraints</option>
                            </select>
                        </div>
                        <button type="button" id="submitRejectButton" class="btn btn-outline-danger">
                            Confirm Rejection
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Bootstrap Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Action</h5>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="modalCancel">Cancel</button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="modalConfirm" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
</div>



<script>
 document.addEventListener("DOMContentLoaded", function() {
    const rejectButton = document.getElementById('rejectButton');
    const approvalButton = document.getElementById('approveButton');
    const rejectionReasonDiv = document.getElementById('rejectionReasonDiv');
    const submitRejectButton = document.getElementById('submitRejectButton');
    const formAction = document.getElementById('formAction');
    const modalMessage = document.getElementById('modalMessage');
    
    // Initialize Bootstrap Modal
    const modalElement = document.getElementById('confirmationModal');
    const bsModal = new bootstrap.Modal(modalElement);
    
    // Initialize Bootstrap Collapse for rejection reason
    const rejectionCollapse = new bootstrap.Collapse(rejectionReasonDiv, { toggle: false });
    
    let currentAction = null;

    // Toggle rejection reason
    rejectButton.addEventListener('click', function() {
        rejectionCollapse.toggle();
    });

    // Approve button click
    approvalButton.addEventListener('click', function() {
        modalMessage.textContent = 'Are you sure you want to approve this request?';
        currentAction = 'approve';
        bsModal.show();
    });

    // Submit rejection (after providing reason)
    submitRejectButton.addEventListener('click', function() {
        const rejectionReason = document.querySelector('[name="rejection_reason"]');
        if (!rejectionReason.value) {
            alert('Please select a rejection reason');
            return;
        }
        modalMessage.textContent = 'Are you sure you want to reject this request?';
        currentAction = 'reject';
        bsModal.show();
    });

    // Confirm action in modal
    document.getElementById('modalConfirm').addEventListener('click', function() {
        if (currentAction) {
            formAction.value = currentAction;
            document.querySelector('form').submit();
        }
        bsModal.hide();
    });
});
</script>
{% endblock %}



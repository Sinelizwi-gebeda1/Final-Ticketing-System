{% extends 'base.html' %}
{% load heroicons %}

{% block title %}CAB Rejection Analysis{% endblock %}

{% block sidebar %}
<div class="flex flex-col h-full justify-between bg-gray-100 w-64 p-4">
    <nav class="flex-grow">
        <ul class="space-y-2">
            <li>
                <a href="{% url 'cab' %}" class="flex items-center gap-2 text-gray-700 hover:text-blue-600">
                    {% heroicon_outline "folder-plus" %}CAB Dashboard 
                </a>
            </li>
            <li>
                <a href="{% url 'cab_stats' %}" class="flex items-center gap-2 text-gray-700 hover:text-blue-600">
                    {% heroicon_outline "chart-bar" %}CAB Stats 
                </a>
            </li>
        </ul>
    </nav>
    <div class="mt-4">
        <a href="{% url 'logout' %}" class="flex items-center gap-2 bg-gray-700 text-white hover:bg-red-500 px-4 py-2 rounded-lg">
            {% heroicon_outline "arrow-left-on-rectangle" class="w-5 h-5" %}
            Logout 
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="flex flex-col items-center px-4 py-6 space-y-6 max-w-5xl mx-auto">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">CAB Rejection Analysis</h2>

    <div id="rejectionChart" class="w-full h-[500px] bg-white rounded-lg shadow-md p-4"></div>
</div>

<!-- Highcharts JS -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const data = [
        {{ analytics.resource_constraints }},
        {{ analytics.incomplete_rollback_plan }},
        {{ analytics.no_business_justification }},
        {{ analytics.high_risk }},
        {{ analytics.insufficient_info }}
    ];

    const labels = [
        'Resource Constraints',
        'Incomplete Rollback Plan',
        'No Business Justification',
        'High Risk',
        'Insufficient Info'
    ];

    const total = data.reduce((a, b) => a + b, 0);

    Highcharts.chart('rejectionChart', {
        chart: {
            type: 'bar',
            backgroundColor: 'transparent',
        },
        title: { text: null },
        xAxis: {
            categories: labels,
            title: { text: null },
            labels: { style: { color: '#111827', fontWeight: '500' } }
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Number of Rejections',
                style: { color: '#111827', fontWeight: '600' }
            },
            labels: { style: { color: '#6B7280', fontWeight: '500' } },
            gridLineColor: '#E5E7EB'
        },
        tooltip: {
            formatter: function() {
                const pct = ((this.y / total) * 100).toFixed(1);
                return `<b>${this.x}</b>: ${this.y} (${pct}%)`;
            }
        },
        plotOptions: {
            series: {
                dataLabels: {
                    enabled: true,
                    formatter: function() {
                        const pct = ((this.y / total) * 100).toFixed(1);
                        return `${this.y} (${pct}%)`;
                    },
                    style: { fontWeight: '500', color: '#111827' }
                },
                color: '#3B82F6', // Tailwind blue-500
                borderRadius: 4,
            }
        },
        legend: { enabled: false },
        credits: { enabled: false },
        series: [{ name: 'Rejections', data: data }]
    });
});
</script>
{% endblock %}
